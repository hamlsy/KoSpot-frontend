# 강제 종료 시 탈퇴 처리 가이드

## 개요

사용자가 브라우저를 강제로 종료하거나 네트워크 연결이 끊겼을 때, 게임 방에서 자동으로 탈퇴 처리하는 방법에 대한 가이드입니다.

## 클라이언트 측 구현 (완료)

### 1. beforeunload 이벤트 처리

**RoomView.vue**와 **SoloGameView.vue**에 `beforeunload` 이벤트 리스너를 추가했습니다.

#### 구현 내용:
- `fetch` API의 `keepalive` 옵션을 사용하여 페이지 종료 시에도 퇴장 요청 전송 시도
- WebSocket 연결 해제 시도
- 구독 해제 처리

#### 제한사항:
- `beforeunload` 이벤트는 동기적으로만 작동하므로 비동기 작업 완료를 보장할 수 없음
- 네트워크가 끊긴 경우 요청이 실패할 수 있음
- 브라우저가 강제 종료되면 요청이 전송되지 않을 수 있음
- **따라서 서버 측 자동 처리가 필수입니다**

## 서버 측 권장 구현 (필수)

클라이언트 측 처리는 완벽하지 않으므로, **서버 측에서도 자동 탈퇴 처리가 필수**입니다.

### 1. WebSocket 연결 끊김 감지

Spring Boot WebSocket에서 연결이 끊겼을 때 자동으로 플레이어를 방에서 제거해야 합니다.

#### 구현 예시:

```java
@Component
public class WebSocketEventListener {
    
    @EventListener
    public void handleWebSocketDisconnectListener(SessionDisconnectEvent event) {
        StompHeaderAccessor headerAccessor = StompHeaderAccessor.wrap(event.getMessage());
        String sessionId = headerAccessor.getSessionId();
        String memberId = headerAccessor.getFirstNativeHeader("memberId");
        String roomId = headerAccessor.getFirstNativeHeader("roomId");
        
        if (memberId != null && roomId != null) {
            // 플레이어를 방에서 제거
            gameRoomService.removePlayerFromRoom(Long.parseLong(roomId), Long.parseLong(memberId));
            
            // 다른 플레이어들에게 퇴장 알림 브로드캐스트
            gameRoomService.broadcastPlayerLeft(Long.parseLong(roomId), Long.parseLong(memberId));
        }
    }
}
```

### 2. 하트비트 타임아웃 처리

WebSocket 연결이 유지되더라도 일정 시간 응답이 없으면 자동으로 탈퇴 처리합니다.

#### 구현 예시:

```java
@Service
public class GameRoomHeartbeatService {
    
    private static final long HEARTBEAT_TIMEOUT = 30000; // 30초
    
    @Scheduled(fixedRate = 10000) // 10초마다 체크
    public void checkHeartbeat() {
        List<GameRoom> activeRooms = gameRoomRepository.findActiveRooms();
        
        for (GameRoom room : activeRooms) {
            List<Player> players = room.getPlayers();
            
            for (Player player : players) {
                long lastHeartbeat = player.getLastHeartbeatTime();
                long now = System.currentTimeMillis();
                
                if (now - lastHeartbeat > HEARTBEAT_TIMEOUT) {
                    // 타임아웃된 플레이어 제거
                    gameRoomService.removePlayerFromRoom(room.getId(), player.getId());
                    gameRoomService.broadcastPlayerLeft(room.getId(), player.getId());
                }
            }
        }
    }
}
```

### 3. 게임 중 강제 종료 처리

게임이 진행 중일 때 플레이어가 강제 종료되면:
- 해당 라운드의 제출을 무효화
- 게임 결과에서 제외
- 다른 플레이어들에게 알림

#### 구현 예시:

```java
public void handlePlayerDisconnectDuringGame(Long roomId, Long memberId) {
    GameRoom room = gameRoomRepository.findById(roomId)
        .orElseThrow(() -> new RoomNotFoundException(roomId));
    
    if (room.isGameInProgress()) {
        // 현재 라운드의 제출 무효화
        roundService.invalidatePlayerSubmission(roomId, memberId);
        
        // 게임 결과에서 제외
        gameResultService.excludePlayerFromResults(roomId, memberId);
        
        // 다른 플레이어들에게 알림
        gameRoomService.broadcastPlayerDisconnected(roomId, memberId);
    }
    
    // 플레이어 제거
    gameRoomService.removePlayerFromRoom(roomId, memberId);
}
```

## 권장 구현 순서

1. **WebSocket 연결 끊김 감지** (최우선)
   - 가장 확실한 방법
   - 즉시 처리 가능

2. **하트비트 타임아웃** (보조)
   - 네트워크 문제로 연결이 끊기지 않았지만 응답이 없는 경우 처리
   - 30초~1분 타임아웃 권장

3. **클라이언트 beforeunload** (보완)
   - 이미 구현 완료
   - 가능한 경우에만 작동

## 테스트 시나리오

1. **브라우저 탭 닫기**
   - WebSocket 연결 끊김 감지 → 즉시 탈퇴 처리

2. **브라우저 종료**
   - WebSocket 연결 끊김 감지 → 즉시 탈퇴 처리

3. **네트워크 연결 끊김**
   - WebSocket 연결 끊김 감지 → 즉시 탈퇴 처리
   - 하트비트 타임아웃 → 30초 후 탈퇴 처리

4. **기기 종료/재시작**
   - WebSocket 연결 끊김 감지 → 즉시 탈퇴 처리

## 주의사항

1. **방장이 강제 종료된 경우**
   - 방장을 다른 플레이어에게 위임하거나
   - 방을 자동으로 폐쇄

2. **게임 진행 중 강제 종료**
   - 해당 플레이어의 점수는 0점 처리
   - 다른 플레이어들에게 공정한 게임 진행 보장

3. **재연결 시도**
   - 일정 시간 내 재연결 시도는 허용할 수 있음
   - 하지만 하트비트 타임아웃은 유지

## 결론

**클라이언트 측 처리는 보완책이며, 서버 측 자동 처리가 핵심입니다.**

서버에서 WebSocket 연결 끊김을 감지하고 자동으로 플레이어를 제거하는 로직을 구현하면, 어떤 상황에서도 안정적으로 탈퇴 처리가 가능합니다.

